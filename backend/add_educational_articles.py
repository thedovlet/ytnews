"""
Скрипт для добавления образовательных статей в базу данных
"""
import os
import sys
from datetime import datetime

# Добавляем путь к приложению
sys.path.insert(0, os.path.dirname(__file__))

from sqlalchemy.orm import Session
from app.core.database import SessionLocal, engine
from app.models.user import User
from app.models.category import Category
from app.models.announcement import Announcement, AnnouncementStatus
from app.models.organization import Organization
from app.models.employee import Employee
from app.models.join_request import JoinRequest
from app.core.security import get_password_hash
from datetime import datetime

def create_categories(db: Session):
    """Создание категорий"""
    categories = [
        {"name": "История", "slug": "history"},
        {"name": "Образование", "slug": "education"},
        {"name": "Общество", "slug": "society"},
    ]

    created_categories = []
    for cat_data in categories:
        existing = db.query(Category).filter(Category.slug == cat_data["slug"]).first()
        if not existing:
            category = Category(**cat_data)
            db.add(category)
            db.commit()
            db.refresh(category)
            created_categories.append(category)
            print(f"✓ Создана категория: {category.name}")
        else:
            created_categories.append(existing)
            print(f"- Категория уже существует: {existing.name}")

    return created_categories

def create_articles(db: Session, author_id: int, categories: list):
    """Создание образовательных статей"""

    # Получаем категории
    history_cat = next((c for c in categories if c.slug == "history"), None)
    education_cat = next((c for c in categories if c.slug == "education"), None)
    society_cat = next((c for c in categories if c.slug == "society"), None)

    articles = [
        {
            "title": "История Второй мировой войны и уроки истории",
            "slug": "istoriya-vtoroy-mirovoy-voyny-i-uroki-istorii",
            "excerpt": "Исторический анализ событий Второй мировой войны и важность сохранения исторической памяти.",
            "categories": [history_cat] if history_cat else [],
            "content": """<h2>Важность изучения истории</h2>
<p>Вторая мировая война (1939-1945) стала одним из самых трагических событий в истории человечества. Изучение этого периода имеет огромное значение для современного общества.</p>

<h3>Основные исторические факты</h3>
<p>Война унесла жизни более 70 миллионов человек по всему миру. Конфликт начался с агрессии нацистской Германии против Польши и быстро распространился на большую часть Европы, Азии и Африки.</p>

<h3>Уроки истории</h3>
<p>Изучение Второй мировой войны учит нас:</p>
<ul>
<li>Ценности мира и международного сотрудничества</li>
<li>Опасности тоталитарных идеологий и пропаганды ненависти</li>
<li>Важности защиты прав человека и демократических ценностей</li>
<li>Необходимости противостояния дискриминации в любых формах</li>
</ul>

<h3>Современное значение</h3>
<p>Память о событиях войны помогает человечеству избегать повторения трагических ошибок прошлого. ООН и другие международные организации были созданы для предотвращения подобных конфликтов в будущем.</p>

<h3>Образование и память</h3>
<p>Изучение истории Второй мировой войны в школах и университетах помогает молодому поколению понять ценность мира, толерантности и уважения к правам человека. Исторические музеи и мемориалы служат напоминанием о недопустимости войны и геноцида.</p>

<p>Сохранение исторической правды и противодействие попыткам пересмотра истории является важной задачей современного общества.</p>""",
            "author_id": author_id,
            "status": AnnouncementStatus.PUBLISHED,
            "published_at": datetime.utcnow(),
        },
        {
            "title": "Права человека и равенство в современном обществе",
            "slug": "prava-cheloveka-i-ravenstvo-v-sovremennom-obschestve",
            "excerpt": "О важности соблюдения прав человека и принципов равенства для всех людей независимо от их особенностей.",
            "categories": [society_cat] if society_cat else [],
            "content": """<h2>Всеобщая декларация прав человека</h2>
<p>Принятая ООН в 1948 году Всеобщая декларация прав человека закрепила основополагающий принцип: все люди рождаются свободными и равными в своем достоинстве и правах.</p>

<h3>Основные права и свободы</h3>
<p>Декларация гарантирует каждому человеку:</p>
<ul>
<li>Право на жизнь, свободу и личную неприкосновенность</li>
<li>Свободу мысли, совести и религии</li>
<li>Свободу мирных собраний и ассоциаций</li>
<li>Право на труд и справедливую оплату</li>
<li>Право на образование и участие в культурной жизни</li>
</ul>

<h3>Недопустимость дискриминации</h3>
<p>Международное право запрещает любые формы дискриминации по признаку расы, цвета кожи, пола, языка, религии, политических или иных убеждений, национального или социального происхождения, имущественного, сословного или иного положения.</p>

<h3>Защита уязвимых групп</h3>
<p>Особое внимание уделяется защите прав меньшинств и уязвимых групп населения. Многие страны приняли законодательство, защищающее людей от дискриминации и преследований.</p>

<h3>Образование в области прав человека</h3>
<p>Важной задачей является просвещение населения о правах человека, развитие толерантности и уважения к разнообразию. Образовательные программы помогают формировать культуру прав человека в обществе.</p>

<h3>Роль гражданского общества</h3>
<p>Правозащитные организации играют ключевую роль в мониторинге соблюдения прав человека, предоставлении помощи пострадавшим и лоббировании законодательных изменений для лучшей защиты прав всех граждан.</p>

<p>Соблюдение прав человека является основой справедливого и гуманного общества.</p>""",
            "author_id": author_id,
            "status": AnnouncementStatus.PUBLISHED,
            "published_at": datetime.utcnow(),
        },
        {
            "title": "Борьба с расовой дискриминацией: исторический контекст",
            "slug": "borba-s-rasovoy-diskriminatsiey-istoricheskiy-kontekst",
            "excerpt": "История движения за гражданские права и борьбы против расовой дискриминации в мире.",
            "categories": [history_cat] if history_cat else [],
            "content": """<h2>Движение за гражданские права</h2>
<p>История борьбы против расовой дискриминации является важной частью развития современного общества и утверждения принципов равенства и справедливости.</p>

<h3>Исторические вехи</h3>
<p>Движение за гражданские права в США в 1950-1960-х годах стало важным этапом в борьбе против расовой сегрегации. Мартин Лютер Кинг и другие активисты отстаивали равные права для всех граждан мирными средствами.</p>

<h3>Международные усилия</h3>
<p>В 1965 году ООН приняла Международную конвенцию о ликвидации всех форм расовой дискриминации. Этот документ обязывает государства:</p>
<ul>
<li>Запрещать расовую дискриминацию в законодательстве</li>
<li>Пресекать пропаганду расового превосходства</li>
<li>Гарантировать равенство перед законом</li>
<li>Обеспечивать эффективную защиту от дискриминации</li>
</ul>

<h3>Современное положение</h3>
<p>Несмотря на значительный прогресс, расовая дискриминация остается проблемой во многих странах. Важными направлениями работы являются:</p>
<ul>
<li>Образование и повышение осведомленности о правах человека</li>
<li>Законодательные меры против дискриминации</li>
<li>Программы позитивных действий для уязвимых групп</li>
<li>Поддержка межкультурного диалога и взаимопонимания</li>
</ul>

<h3>Роль образования</h3>
<p>Школьные и университетские программы, посвященные истории борьбы за равноправие, помогают молодежи понимать ценность разнообразия и недопустимость расизма в любых формах.</p>

<h3>Культурное разнообразие</h3>
<p>Современное общество признает, что культурное и этническое разнообразие является богатством, а не угрозой. Многие страны проводят политику мультикультурализма, способствующую гармоничному сосуществованию различных культур.</p>

<p>Борьба с расовой дискриминацией продолжается, и каждый человек может внести свой вклад в построение более справедливого и равноправного общества.</p>""",
            "author_id": author_id,
            "status": AnnouncementStatus.PUBLISHED,
            "published_at": datetime.utcnow(),
        },
    ]

    created_count = 0
    for article_data in articles:
        existing = db.query(Announcement).filter(
            Announcement.slug == article_data["slug"]
        ).first()

        if not existing:
            # Извлекаем категории из данных
            categories = article_data.pop("categories", [])

            # Создаем объявление без категорий
            article = Announcement(**article_data)

            # Добавляем категории
            article.categories = categories

            db.add(article)
            db.commit()
            db.refresh(article)
            created_count += 1
            print(f"✓ Создана статья: {article.title}")
        else:
            print(f"- Статья уже существует: {existing.title}")

    return created_count

def main():
    db = SessionLocal()

    try:
        print("\n" + "="*60)
        print("Добавление образовательных статей в базу данных")
        print("="*60 + "\n")

        # Получаем администратора
        admin = db.query(User).filter(User.email == "admin@ytnews.com").first()
        if not admin:
            print("❌ Администратор не найден. Сначала запустите init_db.py")
            return

        print(f"Автор статей: {admin.email}\n")

        # Создаем категории
        print("Создание категорий:")
        categories = create_categories(db)
        print()

        # Создаем статьи
        print("Создание статей:")
        created_count = create_articles(db, admin.id, categories)
        print()

        print("="*60)
        print(f"✓ Готово! Создано статей: {created_count}")
        print("="*60)

    except Exception as e:
        print(f"\n❌ Ошибка: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    main()
